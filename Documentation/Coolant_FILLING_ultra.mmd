flowchart TD
F1[Enter FILLING] --> F2[Read START_TS from RTC]
F2 --> F3[Reset pulse counter]
F3 --> F4[Open valve]
F4 --> F5[Count flow pulses]
F5 --> F6{MAX reached}
F6 -- Yes --> F7[Close valve STATUS OK]
F6 -- No --> F8{Timeout}
F8 -- No --> F5
F8 -- Yes --> F9[Close valve STATUS TIMEOUT]
F7 --> F10[Read STOP_TS from RTC]

F10 --> F11[Compute volume from pulses]
F11 --> F12[Sample pH]
F12 --> F13[Write CSV to SD]
F13 --> F14[Go to IDLE]
F9-->E1[Enter ERROR]